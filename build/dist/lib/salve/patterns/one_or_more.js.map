{"version":3,"file":"one_or_more.js","sourceRoot":"","sources":["../../../../../lib/salve/patterns/one_or_more.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Pattern and walker for RNG's ``oneOrMore`` elements.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\nimport { NameResolver } from \"../name_resolver\";\nimport { union } from \"../set\";\nimport { EndResult, EventSet, InternalFireEventResult, InternalWalker,\n         isAttributeEvent, OneSubpattern, Pattern} from \"./base\";\n\n/**\n * A pattern for ``<oneOrMore>``.\n */\nexport class  OneOrMore extends OneSubpattern {\n  newWalker(): InternalWalker {\n    const hasAttrs = this.hasAttrs();\n    const currentIteration = this.pat.newWalker();\n\n    // tslint:disable-next-line:no-use-before-declare\n    return new OneOrMoreWalker(this,\n                               currentIteration,\n                               undefined,\n                               hasAttrs,\n                               this.pat,\n                               !hasAttrs || currentIteration.canEndAttribute,\n                               currentIteration.canEnd);\n  }\n}\n\n/**\n * Walker for [[OneOrMore]]\n */\nclass OneOrMoreWalker implements InternalWalker {\n  constructor(protected readonly el: OneOrMore,\n              private currentIteration: InternalWalker,\n              private nextIteration: InternalWalker | undefined,\n              private readonly hasAttrs: boolean,\n              private readonly subPat: Pattern,\n              public canEndAttribute: boolean,\n              public canEnd: boolean) {}\n\n  clone(): this {\n    return new OneOrMoreWalker(this.el,\n                               this.currentIteration.clone(),\n                               this.nextIteration !== undefined ?\n                               this.nextIteration.clone() : undefined,\n                               this.hasAttrs,\n                               this.subPat,\n                               this.canEndAttribute,\n                               this.canEnd) as this;\n  }\n\n  possible(): EventSet {\n    const ret = this.currentIteration.possible();\n\n    if (this.currentIteration.canEnd) {\n      if (this.nextIteration === undefined) {\n        this.nextIteration = this.subPat.newWalker();\n      }\n      union(ret, this.nextIteration.possible());\n    }\n\n    return ret;\n  }\n\n  possibleAttributes(): EventSet {\n    const ret = this.currentIteration.possibleAttributes();\n\n    if (this.currentIteration.canEnd) {\n      if (this.nextIteration === undefined) {\n        this.nextIteration = this.subPat.newWalker();\n      }\n      union(ret, this.nextIteration.possibleAttributes());\n    }\n\n    return ret;\n  }\n\n  fireEvent(name: string, params: string[],\n            nameResolver: NameResolver): InternalFireEventResult {\n    if (!this.hasAttrs && isAttributeEvent(name)) {\n      return new InternalFireEventResult(false);\n    }\n\n    const currentIteration = this.currentIteration;\n\n    const ret = currentIteration.fireEvent(name, params, nameResolver);\n    if (ret.matched) {\n      this.canEndAttribute = currentIteration.canEndAttribute;\n      this.canEnd = currentIteration.canEnd;\n\n      return ret;\n    }\n\n    if (currentIteration.canEnd) {\n      let next = this.nextIteration;\n      if (next === undefined) {\n        next = this.nextIteration = this.subPat.newWalker();\n      }\n      const nextRet = next.fireEvent(name, params, nameResolver);\n      if (nextRet.matched) {\n        if (currentIteration.end()) {\n          throw new Error(\n            \"internal error; canEnd returns true but end() fails\");\n        }\n\n        this.currentIteration = next;\n        this.nextIteration = undefined;\n        this.canEndAttribute = next.canEndAttribute;\n        this.canEnd = next.canEnd;\n      }\n\n      return nextRet;\n    }\n\n    return ret;\n  }\n\n  end(): EndResult {\n    return this.canEnd ? false : this.currentIteration.end();\n  }\n\n  endAttributes(): EndResult {\n    return this.canEndAttribute ? false : this.currentIteration.endAttributes();\n  }\n}\n\n//  LocalWords:  RNG's MPL currentIteration nextIteration canEnd oneOrMore rng\n//  LocalWords:  anyName suppressAttributes instantiateCurrentIteration\n"]}